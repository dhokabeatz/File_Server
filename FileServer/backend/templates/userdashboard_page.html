{% extends 'base.html' %}

{% block title %}File Server - User Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
  <form method="get" action="{% url 'userDashboard' %}">
    <div class="input-group mb-3">
      <input type="text" class="form-control" name="q" placeholder="Search files..." value="{{ request.GET.q }}" />
      <button class="btn btn-primary" type="submit">Search</button>
    </div>
  </form>

  <button id="download-selected" class="btn btn-success mb-3">
    Download Selected
  </button>

  <div class="dashboard">
    {% for document in documents %}
    <div class="file-card">
      <input type="checkbox" class="select-file" data-file-id="{{ document.id }}" />
      <div class="file-info">
        <h3 class="file-title">{{ document.title }}</h3>
        <p class="file-description">{{ document.description }}</p>
      </div>
      <div class="file-actions">
        <button class="btn btn-primary open-btn" data-title="{{ document.title }}"
          data-description="{{ document.description }}" data-file-url="{{ document.file.url }}">
          Open
        </button>
        <a href="#" class="btn btn-info download-btn" onclick="downloadFile('{{ document.id }}')">Download</a>
        <button class="btn btn-warning email-btn" data-title="{{ document.title }}"
          data-file-url="{{ document.file.url }}" data-file-id="{{ document.id }}">
          Email
        </button>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Modal Structure -->
<div id="fileModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="modal-title"></h3>
    <p id="modal-description"></p>
    <a id="modal-download" href="" class="btn btn-info" download>Download</a>
    <button id="modal-email" class="btn btn-warning">Email</button>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", (event) => {
    const modal = document.getElementById("fileModal");
    const modalTitle = document.getElementById("modal-title");
    const modalDescription = document.getElementById("modal-description");
    const modalDownload = document.getElementById("modal-download");
    const modalEmail = document.getElementById("modal-email");
    const span = document.getElementsByClassName("close")[0];

    // Open button click event
    document.querySelectorAll(".open-btn").forEach((button) => {
      button.addEventListener("click", function () {
        const title = this.getAttribute("data-title");
        const description = this.getAttribute("data-description");
        const fileUrl = this.getAttribute("data-file-url");

        modalTitle.textContent = title;
        modalDescription.textContent = description;
        modalDownload.href = fileUrl;
        modalEmail.setAttribute("data-file-url", fileUrl);

        modal.style.display = "block";
      });
    });

    // Close button event
    span.onclick = function () {
      modal.style.display = "none";
    };

    // Click outside of modal to close it
    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    };

    // Email button click event
    document.querySelectorAll(".email-btn").forEach((button) => {
      button.addEventListener("click", function () {
        const fileId = this.getAttribute("data-file-id");
        window.location.href = `/email/${fileId}/`; // Adjust the URL as needed
      });
    });

    // Multiple download button click event
    const downloadButton = document.getElementById("download-selected");
    downloadButton.addEventListener("click", function () {
      const selectedFiles = document.querySelectorAll(
        ".select-file:checked"
      );
      const fileIds = Array.from(selectedFiles).map((cb) =>
        cb.getAttribute("data-file-id")
      );

      if (fileIds.length > 0) {
        const formData = new FormData();
        formData.append("file_ids", JSON.stringify(fileIds));

        fetch("/download-multiple/", {
          method: "POST",
          body: formData,
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
          },
        })
          .then((response) => response.blob())
          .then((blob) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "files.zip";
            document.body.appendChild(a);
            a.click();
            a.remove();
          })
          .catch((error) => console.error("Error:", error));
      } else {
        alert("Please select at least one file to download.");
      }
    });

    function downloadFile(fileId) {
    // Make an AJAX request to your Django view
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/download/' + fileId + '/');
    xhr.responseType = 'blob'; // Set the responseType to blob for binary data

    xhr.onload = function() {
        if (xhr.status === 200) {
            // Create a temporary link element and trigger the download
            var blob = new Blob([xhr.response], { type: xhr.getResponseHeader('Content-Type') });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = xhr.getResponseHeader('Content-Disposition').split('filename=')[1].trim();
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }
    };

    xhr.send();
}

    // Function to retrieve CSRF token from cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(
              cookie.substring(name.length + 1)
            );
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>

{% endblock %}